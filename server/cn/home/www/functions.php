<?php
include 'config.php';

session_start();

/**global var**/
$jquery=0;


/**functions for html **/

//print a html header
function yimian__header($title="Yimian",$keywords="yimian",$description="Yimian Website")
{

	echo "<!--

   ___     ___
  |\  \    |  |
  \ \  \   |  |
   \ \  \  |  |
    \ \  \_|  |  ___    _____________    ___    _________      _________     
     \ \     /  |\  \  |\   __   __  \  |\  \  |\   ___  \    |\   ___  \ 
      \ \  \/   \ \  \ \ \  \-\  \-\  \ \ \  \ \ \  \--\  \   \ \  \--\  \ 
       \ \  \    \ \  \ \ \  \ \  \ \  \ \ \  \ \ \  \  \  \   \ \  \  \  \
        \ \  \    \ \  \ \ \  \ \  \ \  \ \ \  \ \ \  \__\  \___\ \  \  \  \ 
         \ \__\    \ \__\ \ \__\ \__\ \__\ \ \__\ \ \___________\\ \__\  \__\
          \|__|     \|__|  \|__| |__| |__|  \|__|  \|___________| \|__|  |__|

-->
";
	echo "<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">
";

	echo "<head>
	<meta charset=\"utf-8\">
    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge,chrome=1\">
	<link rel=\"icon\" href=\"https://cdn.yimian.xyz/img/logo/logo.ico\" type=\"image/x-icon\"/>
	<title>".$title."</title>
    <meta name=\"viewport\" content=\"width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no\"/>
   	<meta name=\"Keywords\" content=\"".$keywords."\">
	<meta name=\"Description\" content=\"".$description."\">";
}


//jquery install
function js__jquery()
{
	if(!$GLOBALS['jquery'])
	{	
	echo "<!-- Include js Jquery and Pjax -->
<script type=\"text/javascript\" src=\"https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js\"></script>
<script type=\"text/javascript\" src=\"https://cdn.bootcss.com/jquery.pjax/2.0.1/jquery.pjax.js\"></script>";
	$GLOBALS['jquery']=1;
	}
}


function js__device()
{
	echo "
<script src=\"https://cdn.bootcss.com/device.js/0.2.7/device.min.js\"></script>";
}


function css__cleverLogin()
{
	echo "
<link rel=\"stylesheet\" type=\"text/css\" href=\"https://cdn.yimian.xyz/clever-login/clever-login_base.css\" />
<link rel=\"stylesheet\" type=\"text/css\" href=\"https://cdn.yimian.xyz/clever-login/clever-login_icon.css\" />
<link rel=\"stylesheet\" type=\"text/css\" href=\"https://cdn.yimian.xyz/clever-login/clever-login_normal.css\" />
<link rel=\"stylesheet\" type=\"text/css\" href=\"https://cdn.yimian.xyz/clever-login/clever-login_reg.css\" />";
}

function css__easyVer()
{
	echo "
<link type=\"text/css\" rel=\"stylesheet\" href=\"https://cdn.yimian.xyz/easyVer/easyVer.min.css\">";
}

//mark the end of the html header
function yimian__headerEnd()
{
	js__jquery();
	echo "
<script>console.log('\\n' + ' %c Yimian  %c https://www.yimian.xyz ' + '\\n', 'color: #00FFFF; background: #030307; padding:5px 0;', 'background: #4682B4; padding:5px 0;');</script>
<script>console.log('Thankfully / Proudly include Plugins:'+'\\n');";

if($GLOBALS['jquery']==1)
echo "console.log('\\n' + ' %c jQuery v3.3.1 %c https://jquery.com '+ '\\n', 'color: #fadfa3; background: #030307; padding:5px 0;', 'background: #fadfa3; padding:5px 0;');console.log('\\n' + ' %c jquery-pjax v2.0.1 %c https://github.com/defunkt/jquery-pjax ' + '\\n', 'color: #fadfa3; background: #030307; padding:5px 0;', 'background: #fadfa3; padding:5px 0;');";
	
echo "</script>
<script src=\"https://cdn.yimian.xyz/cookie/cookie.js\"></script>
<script src=\"https://pv.sohu.com/cityjson?ie=utf-8\"></script>
<script type=\"text/javascript\">ip=returnCitySN.cip;ipCity=returnCitySN.cname;</script>
<script src=\"https://cdn.yimian.xyz/fp/fp.min.js\"></script>
<script src=\"https://cdn.yimian.xyz/heartbeat/heartbeat_head.min.js\"></script>
</head>
	
<body>";
}

function js__easyVer()
{
	echo "
<script type=\"text/javascript\" src=\"https://cdn.yimian.xyz/easyVer/easyVer.min.js\"></script>";
}

function js__cleverLogin()
{
	echo "
<script type=\"text/javascript\" src=\"https://cdn.yimian.xyz/clever-login/polygonizr.min.js\"></script>
<script type=\"text/javascript\">$('#site-landing').polygonizr();</script>
<script type=\"text/javascript\" src=\"https://cdn.yimian.xyz/clever-login/clever-login.min.js\"></script>";
	js__easyVer();
}


function yimian__heartbeat()
{
	echo "
<script src=\"https://cdn.yimian.xyz/heartbeat/heartbeat_footer.min.js\"></script>";
}


function yimian__simpleFooter($bodyEnd=0)
{
	
	if(!$bodyEnd) echo "
</body>";
	yimian__heartbeat();
		echo "
</html>";
	
		
}

//print a html footer
function yimian__footer($wordColor="#C7C7C7",$backgroundColor="#2B2B2B",$urlColor="#87CEEB")
{
	echo "	<style>/*footer theme*/footer{padding:1.5rem 1rem;color:".$wordColor.";font-size:1.2rem;line-height:1.4;text-align:center;background:".$backgroundColor.";border-top:1px solid #C7C7C7}a.footera:link{color: ".$urlColor." ; text-decoration:none;}a.footera:visited {color:#79CDCD}</style>
	<script>function openwin(){window.open(\"https://iotcat.me\");}</script>
	<footer class=\"footer\">Â© 2018-".date("Y")." Copyright <a class=\"footera\" onclick=\"openwin()\" href=\"#\">IoTcat</a> </footer>";
	yimian__heartbeat();
	echo "</body>
</html>";
}


//set fp cookie
function yimian__setFp(){

	echo "<script src=\"https://cdn.yimian.xyz/cookie/cookie.js\"></script>
<script src=\"https://cdn.yimian.xyz/fp/fp.js\"></script>
<script>cookie.set(\"fp\", fp);</script>
<script>location.reload(false);</script>";

die();
}


// user login
function db__getUsrInfo($fp){

    $conn = db__connect();
    $res = db__getData($conn, "fp", "fp", $fp);
    $usr = db__getData($conn, "user", "tel", $res[0]['usr']);

    return $usr[0];
}


/**added functions**/
//get millis time stamp
function millis() {
list($msec, $sec) = explode(' ', microtime());
return $msectime = (float)sprintf('%.0f', (floatval($msec) + floatval($sec)) * 1000);
}



/**database connection**/

//connect to database
function db__connect($servername="",$username="",$password="",$dbname="")
{
	/* reset */
	if($servername=="") $servername=$GLOBALS['g_db_serverName'];
	if($username=="") $username=$GLOBALS['g_db_usrName'];
	if($password=="") $password=$GLOBALS['g_db_psswd'];
	if($dbname=="") $dbname=$GLOBALS['g_db_dbName'];

	if($servername == "log"){

		$servername = $GLOBALS['g_db_log_serverName'];
		$username = $GLOBALS['g_db_log_usrName'];
		$password = $GLOBALS['g_db_log_psswd'];
		$dbname = $GLOBALS['g_db_log_dbName'];
	}elseif($servername == "yulu"){

		$servername = $GLOBALS['g_db_serverName'];
		$username = $GLOBALS['g_db_usrName'];
		$password = $GLOBALS['g_db_psswd'];
		$dbname = "yulu";
	}
	
	$conn = new mysqli($servername, $username, $password, $dbname);

	if ($conn->connect_error) 
	{
		die("Mysql Connect Failed: " . $conn->connect_error);
	} 

	return ($conn);
}

//get table row number::(data_cnnct var,table name) ::(row number)
function db__rowNum($conn,$table,$clmnName="",$value="",$clmnName2="",$value2="")
{
	
	$table=db__antisql($table);
	$clmnName=db__antisql($clmnName);
	$value=db__antisql($value);
	$clmnName2=db__antisql($clmnName2);
	$value2=db__antisql($value2);
	
	
	if($clmnName=="") $sql = "SELECT COUNT(*) FROM $table";
	elseif($clmnName2=="") $sql = "SELECT COUNT(*) FROM $table where $clmnName='$value'";
	else $sql = "SELECT COUNT(*) FROM $table where $clmnName='$value' AND $clmnName2='$value2'";
	
	$row_count = $conn->query($sql);   
	list($row_num) = $row_count->fetch_row(); 
	return ($row_num);
}

//get row data from database::(data_cnnct var, table name,column name, column value)::(row info)
function db__getData($conn,$table,$clmnName="",$value="",$clmnName2="",$value2="")
{
	
	$table=db__antisql($table);
	$clmnName=db__antisql($clmnName);
	$value=db__antisql($value);
	$clmnName2=db__antisql($clmnName2);
	$value2=db__antisql($value2);
		

	if($clmnName=="") $sql = "SELECT * FROM $table";
	elseif($clmnName2=="") $sql = "SELECT * FROM $table where $clmnName='$value'";
	else $sql = "SELECT * FROM $table where $clmnName='$value' AND $clmnName2='$value2'";
		
	$result = $conn->query($sql);
	//no data
	if ($result->num_rows > 0) {}else{return 404;}

	$i=0;
	$arr=array();
	while($row = $result->fetch_assoc()) {
		$arr[$i++]=$row;
	}
	return ($arr);
}


//fnct for insert a row to database
function db__insertData($conn,$table,$content)
{	
	$table=db__antisql($table);
	
	$key=array_keys($content);
	
	$key=db__antisql($key);
	
	$sql="insert INTO $table (";
	
	for($i=0;$i<count($key);$i++)
	{
		$sql.="$key[$i]";
		if($i!=count($key)-1) $sql.=", ";
	}
	
	$sql.=") VALUES (";
	
	for($i=0;$i<count($key);$i++)
	{
		$tmp_key=$key[$i];
		$content[$tmp_key]=db__antisql($content[$tmp_key]);
		$sql.="'$content[$tmp_key]'";
		if($i!=count($key)-1) $sql.=", ";
	}
	
	$sql.=")";
	
	if (!($conn->query($sql) === TRUE))  echo "SQL Insert Error: " . $sql . "<br>" . $conn->error;

}


//fnct for update a row to database without check
function db__updateData($conn,$table,$content,$index)
{	
	$key=array_keys($content);
	$key=db__antisql($key);
	
	$sql="UPDATE $table SET ";
	
	for($i=0;$i<count($key);$i++)
	{
		$tmp_key=$key[$i];
		$content[$tmp_key]=db__antisql($content[$tmp_key]);
		$sql.="$key[$i]='$content[$tmp_key]'";
		if($i!=count($key)-1) $sql.=", ";
	}
	
	$key=array_keys($index);
	$key=db__antisql($key);
	
	$sql.=" WHERE ";
	
	for($i=0;$i<count($key);$i++)
	{
		$tmp_key=$key[$i];
		$index[$tmp_key]=db__antisql($index[$tmp_key]);
		$sql.="$tmp_key='$index[$tmp_key]'";
		if($i!=count($key)-1) $sql.=" AND ";
	}
	
	if (!($conn->query($sql) === TRUE))  echo "SQL Insert Error: " . $sql . "<br>" . $conn->error;

}




//push row data from database::(data_cnnct var, table name,column name, column value)::(row info)
function db__pushData($conn,$table,$content,$index="",$is_force=1)
{
	if($index)
	{
		$index_keys=array_keys($index);

		if(count($index_keys)==1) $result=db__rowNum($conn,$table,$index_keys[0],$index[$index_keys[0]]); 
			
		elseif(count($index_keys)==2)	$result=db__rowNum($conn,$table,$index_keys[0],$index[$index_keys[0]],$index_keys[1],$index[$index_keys[1]]); 
			
		else return -1;
			
		if($result>0) db__updateData($conn,$table,$content,$index);
		else if($is_force) db__insertData($conn,$table,$content);
			
	}
	else
		db__insertData($conn,$table,$content);
}


function db__delData($conn, $table, $clmnName, $value)
{
	$value=db__antisql($value);
	$clmnName=db__antisql($clmnName);

	$sql = "DELETE FROM $table WHERE $clmnName = '$value'";
	$conn->query($sql);
}


//anti sql
function db__antisql($str)
{
	return(str_ireplace("'","",$str));
}


/*****log******/
function yimian__log($table, $val, $index = ""){

	if($index != "") db__pushData(db__connect("log"), $table, $val, $index);
	else db__pushData(db__connect("log"), $table, $val);
}




/***tools***/
//fnct of get usr ip::()::(ip)
function get_ip() 
{
	if (getenv("HTTP_CLIENT_IP") && strcasecmp(getenv("HTTP_CLIENT_IP"), "unknown")) 
	{
		$ip = getenv("HTTP_CLIENT_IP");
	} 
	else
		if (getenv("HTTP_X_FORWARDED_FOR") && strcasecmp(getenv("HTTP_X_FORWARDED_FOR"), "unknown")) 
		{
			$ip = getenv("HTTP_X_FORWARDED_FOR");
		}
		else
			if (getenv("REMOTE_ADDR") && strcasecmp(getenv("REMOTE_ADDR"), "unknown")) 
			{
				$ip = getenv("REMOTE_ADDR");
			} 
			else
				if (isset ($_SERVER['REMOTE_ADDR']) && $_SERVER['REMOTE_ADDR'] && strcasecmp($_SERVER['REMOTE_ADDR'], "unknown")) 
				{
					$ip = $_SERVER['REMOTE_ADDR'];
				} 
				else 
				{
					$ip = "unknown";
				}
return ($ip);
}

/** get from address **/
function get_from(){

    if($_SERVER['HTTP_REFERER']) return $_SERVER['HTTP_REFERER'];
    elseif($_REQUEST['from']) return $_REQUEST['from'];
}

function get_from_domain(){

    	$str = str_replace("http://","",get_from());
    	$str = str_replace("https://","",$str);
		$strdomain = explode("/",$str);
		return $strdomain[0];
}


/** function for mail **/

function yimian__mail($to, $subject, $body, $from){


    if($from == "") $from = "IoTcat ååµé±";
    if($body == "") $body = "é¢(âï¹â) æªæ¾å°æå®çé®ä»¶åå®¹è¶( â¢Ì Ï â¢Ì )y<br/><br/>æ´å¤ä¿¡æ¯è¯·å¨è¯¢<a href = 'https://iotcat.me'>IoTcat</a>æå¾ä½ çååºå¦~";
    if($subject == "") $subject = "æ¥èªIoTcatçä¸å£°é®å~";

    $data = array(
        'fromName' => $from, // åä»¶äººåç§°
        'from' => "admin@iotcat.xyz", // åä»¶å°å
        'to' => $to, // æ¶ä»¶å°å
        'replyTo' => "i@iotcat.me", // åä¿¡å°å
        'subject' => $subject,
        'html' => $body
    );

    // å½åè¯·æ±åºå
    // æ­å·
    // APIå°å
    $data['api'] = 'https://dm.aliyuncs.com/';
    // APIçæ¬å·
    $data['version'] = '2015-11-23';
    // æºæ¿ä¿¡æ¯
    $data['region'] = 'cn-hangzhou';

    // AccessKeyId
    $data['accessid'] = $GLOBALS['aym_AccessKey'];
    // AccessKeySecret
    $data['accesssecret'] = $GLOBALS['aym_SecretKey'];
    // æ¯å¦æå
    return aliyun($data);

}



/**functions for aplayer**/

//put this function to where you want the aplayer to dispaly
function aplayer__element()
{
	echo "<div id=\"aplayer\" class=\"aplayer\"></div>";
}
	
	
//this should put at the near the need of a body,
//the js object name is ap.
function aplayer__setup()
{
	echo "<link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.css\">
<script src=\"https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.js\"></script>";
	echo "<script src=\"https://cdn.yimian.ac.cn/aplayer/setup.js\"></script>";
}


//this should put at the near the need of a body,
//the js object name is ap.
function aplayer__setup_mini()
{
	echo "<link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.css\">
<script src=\"https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.js\"></script>";
	echo "<script src=\"https://cdn.yimian.ac.cn/aplayer/setup_mini.js\"></script>";
}

//the should put behind the setup function
function aplayer__add($name="",$artist="unknown",$url="",$coverurl="",$lrcurl="",$theme="#ebd0c2")
{
	echo "<script>//script for adding a new music to aplayer
	ap.list.add([{
    name: '".$name."',
    artist: '".$artist."',
    url: '".$url."',
    cover: '".$coverurl."',
    lrc: '".$lrcurl."',
    theme: '".$theme."'
}]);
</script>";
}

//play a netease playlist
function aplayer__netease($playlistid="2012006204",$loadStart=0,$numLimit=10,$theme="#ebd0c2")
{
	if(!$GLOBALS['jquery']) js__jquery();
	echo "<script>
	var nameList=new Array();
	var artistList=new Array();
	var urlList=new Array();
	var coverList=new Array();
	var lrcList=new Array();
	var themeList=new Array();
	$.ajax({
        type: \"GET\",
        url: 'https://api.bzqll.com/music/netease/songList',
        data: { \"key\": 579621905,
			  	\"id\": $playlistid,
				\"limit\": $numLimit},
        traditional: true,
        dataType: 'json',
        success: function (msg) {
		   for(var i=$loadStart;i<Math.min(msg.data.songListCount,$numLimit);i++)
		   {
		   		ap.list.add([{
				name: msg.data.songs[i].name,
				artist: msg.data.songs[i].singer,
				url: msg.data.songs[i].url,
				cover: msg.data.songs[i].pic,
				lrc: msg.data.songs[i].lrc,
				theme: '$theme'
				}]);
				
				nameList[i-$loadStart]=msg.data.songs[i].name;
				artistList[i-$loadStart]=msg.data.songs[i].singer;
				urlList[i-$loadStart]=msg.data.songs[i].url;
				coverList[i-$loadStart]=msg.data.songs[i].pic;
				lrcList[i-$loadStart]=msg.data.songs[i].lrc;
				themeList[i-$loadStart]='$theme';
		   }
        }
    });
	</script>";
	
}




/**functions for dplayer**/

//put this function to where you want the dplayer to dispaly
function dplayer__element()
{
	echo "<div id=\"dplayer\"></div>";
}
	
	
//this should put at the near the need of a body,
//the js object name is dp.
function dplayer__setup()
{
	echo "<script src=\"https://pv.sohu.com/cityjson?ie=utf-8\"></script>
";
	echo "<link rel=\"stylesheet\" href=\"https://cdn.yimian.xyz/dplayer/DPlayer.min.css\">
<script src=\"https://cdn.yimian.xyz/dplayer/DPlayer.min.js\"></script>";
	echo "<script type=\"text/javascript\" src=\"https://cdn.yimian.xyz/dplayer/setup.js\"></script>
";
echo "<script src=\"https://pv.sohu.com/cityjson?ie=utf-8\"></script>";
}

	
//this should put at the near the need of a body,
//the js object name is dp.
function dplayer__setup_once($id)
{
	echo "<script src=\"https://pv.sohu.com/cityjson?ie=utf-8\"></script>
<script src=\"https://cdn.bootcss.com/hls.js/0.10.1/hls.min.js\"></script>
";
	echo "<link rel=\"stylesheet\" href=\"https://cdn.yimian.xyz/dplayer/DPlayer.min.css\">
<script src=\"https://cdn.yimian.xyz/dplayer/DPlayer.min.js\"></script>";
	echo "<script type=\"text/javascript\">//script for set up the dplayer
//global var for storing current video info
var g_vId=$id;
</script>
<script src=\"https://cdn.yimian.xyz/dplayer/setup_once.js\"></script>
";
echo "<script src=\"https://pv.sohu.com/cityjson?ie=utf-8\"></script>";
}

//this should put behind the setup function
function dplayer__add($id="234")
{
	echo "<script>//script for adding a new video to aplayer
newVideo('$id');
</script>";
}




/****API******/


//fnct for dogecloud API
function api__dogecloud($platform,$vcode,$ip,$AccessKey,$SecretKey){
	
	$url="https://api.dogecloud.com/video/streams.json?platform=$platform&vcode=$vcode&ip=$ip";
	
	$str="/video/streams.json?platform=$platform&vcode=$vcode&ip=$ip"."\n";

	$str  = hash_hmac("sha1", $str, $SecretKey);
	
    $headerArray =array("Host:api.dogecloud.com","Authorization: TOKEN ".$AccessKey.":".$str);
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, TRUE); 
    curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, TRUE); 
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($ch,CURLOPT_HTTPHEADER,$headerArray);
    $output = curl_exec($ch);
	if($errno = curl_errno($ch)) {
    	$error_message = curl_strerror($errno);
		echo "cURL error ({$errno}):\n {$error_message}";
	}

    curl_close($ch);
	
    return $output;
}



/****Yimian Video*******/

function video__bodyUp()
{
	if(!isset($_REQUEST['_pjax'])) 
	{
		yimian__header("Yimian Video","video,Yimian","This is the page for showing video class.");

		echo "<link rel=\"stylesheet\" type=\"text/css\" href=\"https://cdn.yimian.xyz/bootstrap/bootstrap.min.css\">
<link rel=\"stylesheet\" href=\"https://cdn.yimian.xyz/video/css/style.css\">";
		
		echo "<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src=\"https://www.googletagmanager.com/gtag/js?id=UA-135901303-2\"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-135901303-2');
</script>";

		yimian__headerEnd();


		echo file_get_contents("https://video.yimian.xyz/body_up.html");
	}
}


function video__bodyDown()
{
	if(!isset($_REQUEST['_pjax'])) 
	{
		echo file_get_contents("https://video.yimian.xyz/body_down.html");
		yimian__simpleFooter();
	}
}







/*****private functions *****/

//mail alliyun api
function aliyun($param)
{
    // éæ°ç»åä¸ºé¿éäºæä½¿ç¨çåæ°
    $data = array(
        'Action' => 'SingleSendMail', // æä½æ¥å£å
        'AccountName' => $param['from'], // åä»¶å°å
        'ReplyToAddress' => "true", // åä¿¡å°å
        'AddressType' => 1, // å°åç±»å
        'ToAddress' => $param['to'], // æ¶ä»¶å°å
        'FromAlias' => $param['fromName'], // åä»¶äººåç§°
        'Subject' => $param['subject'], // é®ä»¶æ é¢
        'HtmlBody' => $param['html'], // é®ä»¶åå®¹
        'Format' => 'JSON', // è¿åJSON
        'Version' => $param['version'], // APIçæ¬å·
        'AccessKeyId' => $param['accessid'], // Access Key ID
        'SignatureMethod' => 'HMAC-SHA1', // ç­¾åæ¹å¼
        'Timestamp' => gmdate('Y-m-d\TH:i:s\Z'), // è¯·æ±æ¶é´
        'SignatureVersion' => '1.0', // ç­¾åç®æ³çæ¬
        'SignatureNonce' => md5(time()), // å¯ä¸éæºæ°
        'RegionId' => $param['region'] // æºæ¿ä¿¡æ¯
    );
    // è¯·æ±ç­¾å
    $data['Signature'] = sign($data, $param['accesssecret']);
    // åå§åCurl
    $ch = curl_init();
    // è®¾ç½®ä¸ºPOSTè¯·æ±
    curl_setopt($ch, CURLOPT_CUSTOMREQUEST, 'POST');
    // è¯·æ±å°å
    curl_setopt($ch, CURLOPT_URL, $param['api']);
    // è¿åæ°æ®
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, TRUE);
    // æäº¤åæ°
    curl_setopt($ch, CURLOPT_POSTFIELDS, getPostHttpBody($data));
    // å³é­ssléªè¯
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE);
    curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, FALSE);
    // æ§è¡è¯·æ±
    $result = curl_exec($ch);
    // è·åéè¯¯ä»£ç 
    $errno = curl_errno($ch);
    // è·åéè¯¯ä¿¡æ¯
    $error = curl_error($ch);
    // è·åè¿åç¶æç 
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    // å³é­è¯·æ±
    curl_close($ch);
    // æåæ è¯
    $flag = TRUE;
    // å¦æå¼å¯äºDebug
    if (1) {
        // è®°å½æ¶é´
        $log = '[Aliyun] ' . date('Y-m-d H:i:s') . ': ' . PHP_EOL;
        // å¦æå¤±è´¥
        if ( $errno ) {
            // è®¾ç½®å¤±è´¥
            $flag = FALSE;
            $log .= 'é®ä»¶åéå¤±è´¥, éè¯¯ä»£ç ï¼' . $errno . 'ï¼éè¯¯æç¤º: ' . $error . PHP_EOL;
        }
        // å¦æå¤±è´¥
        if ( 400 <= $httpCode ) {
            // è®¾ç½®å¤±è´¥
            $flag = FALSE;
            // å°è¯è½¬æ¢json
            if ( $json = json_decode($result) ) {
                $log .= 'é®ä»¶åéå¤±è´¥ï¼éè¯¯ä»£ç ï¼' . $json->Code . 'ï¼éè¯¯æç¤ºï¼' . $json->Message . PHP_EOL;
            } else {
                $log .= 'é®ä»¶åéå¤±è´¥, è¯·æ±è¿åHTTP Codeï¼' . $httpCode . PHP_EOL;
            }
        }
        // è®°å½è¿åå¼
        $log .= 'é®ä»¶åéè¿åæ°æ®ï¼' . serialize($result) . PHP_EOL;
        // åå¥æä»¶
    }
    yimian__log("log_mail",array("timestamp" => date('Y-m-d H:i:s', time()), "to_" => $param['to'], "from_" => $param['fromName'], "subject" => $param['subject'], "body" => $param['html'], "success" => (($flag)?1:0), "return_" => $log));
    // è¿åç»æ
    return $flag;
} 


/**
 * é¿éäºç­¾å
 *
 * @static
 * @access private
 *
 * @param array  $param        ç­¾ååæ°
 * @param string $accesssecret ç§é¥
 *
 * @return string
 */
function sign($param, $accesssecret)
{
    // åæ°æåº
    ksort($param);
    // ç»ååºç¡
    $stringToSign = 'POST&' . percentEncode('/') . '&';
    // ä¸´æ¶åé
    $tmp = '';
    // å¾ªç¯åæ°åè¡¨
    foreach ( $param as $k => $v ) {
        // ç»ååæ°
        $tmp .= '&' . percentEncode($k) . '=' . percentEncode($v);
    }
    // å»é¤æåä¸ä¸ª&
    $tmp = trim($tmp, '&');
    // ç»åç­¾ååæ°
    $stringToSign = $stringToSign . percentEncode($tmp);
    // æ°æ®ç­¾å
    $signature = base64_encode(hash_hmac('sha1', $stringToSign, $accesssecret . '&', TRUE));
    // è¿åç­¾å
    return $signature;
}

/**
 * é¿éäºç­¾åç¼ç è½¬æ¢
 *
 * @static
 * @access private
 *
 * @param string $val è¦è½¬æ¢çç¼ç 
 *
 * @return string|string[]|null
 */
function percentEncode($val)
{
    // URLç¼ç 
    $res = urlencode($val);
    // å å·è½¬æ¢ä¸º%20
    $res = preg_replace('/\+/', '%20', $res);
    // æå·è½¬æ¢ä¸º%2A
    $res = preg_replace('/\*/', '%2A', $res);
    // %7Eè½¬æ¢ä¸º~
    $res = preg_replace('/%7E/', '~', $res);
    return $res;
}

/**
 * é¿éäºè¯·æ±åæ°ç»å
 *
 * @static
 * @access private
 *
 * @param array $param åéåæ°
 *
 * @return bool|string
 */
function getPostHttpBody($param)
{
    // ç©ºå­ç¬¦ä¸²
    $str = "";
    // å¾ªç¯åæ°
    foreach ( $param as $k => $v ) {
        // ç»ååæ°
        $str .= $k . '=' . urlencode($v) . '&';
    }
    // å»é¤ç¬¬ä¸ä¸ª&
    return substr($str, 0, -1);
}
